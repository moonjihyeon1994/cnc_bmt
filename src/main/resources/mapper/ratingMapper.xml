<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cnc.rating.mybatis.RatingMapper">
    <select id="select" parameterType="String" resultType="map">
        select *
        from online_evdo_rated_cdr a
                 join ui_minor_code b
                      on a.ag_service_type_name = b.code_id
        WHERE service_mgmt_no = #{service_mgmt_no}
          AND usg_start_date >= 20200400
          AND usg_start_date &lt;= 20200501
          AND concat(usg_start_date, usg_start_time) >= '202004010000000'
          AND concat(usg_start_date, usg_start_time) &lt;= '202005012359599'
          AND b.major_id = 'EVDO_AG_SERVICE_TYPE'
    </select>
    <select id="selectTest" resultType="map">
        select * from test.online_evdo_rated_cdr where usg_start_date >= '20200305';
    </select>
    <select id="selectCDR" parameterType="String" resultType="map">
        SELECT IF(usg_type = 550, '서킷데이터', '데이터통화')     cdr_kind,
               33                                       cdr_kind_order,
               DATE_FORMAT(usg_start_date, '%Y/%m/%d')  usg_start_date,
               usg_start_time                           usg_start_time,
               total_duration                           total_duration,
               ''                                       rat_term_phon_num,
               ''                                       rat_term_phon_num_xxx,
               total_usg_nou,
               total_used_charge,
               total_rated_charge,
               (total_used_charge - total_rated_charge) deduct_discount_charge,
               deduct_code1,
               deduct_code2,
               deduct_code3,
               deduct_code4,
               deduct_code5,
               disc_code1,
               disc_code2,
               disc_code3,
               msc_switch_id                            switch_id,
               CONCAT(cell_id, ocall_toll_id) AS        cell_id,
               ''                                       tzone,
               usg_type,
               CASE
                   WHEN opmd_flag = 7 THEN '스마트와치(AW) 데이터공유'
                   WHEN LENGTH(CH_SVC_ICCID) = 14 THEN CONCAT(substr(ch_svc_iccid, 0, 4), '-',
                                                              substr(ch_svc_iccid, 5, 4), '-',
                                                              substr(ch_svc_iccid, 9, 4), '-', substr(ch_svc_iccid, 13))
                   ELSE IFNULL(CH_SVC_ICCID, '')
                   END                                  bigo_name,
               ag_service_type_name                     cont_product_name,
               network_type,
               processed_date,
               processed_time,
               ''                                       service_term_date,
               ''                                       service_term_time,
               usg_seq
        FROM
             (SELECT usg_start_date,
                     usg_start_time,
                     total_duration,
                     IF(USG_TYPE = 620,
                        (CASE a.PROD_ID
                             WHEN 'NA00002738' THEN AG_USED_NOU * 1024
                             WHEN 'NA00002739' THEN AG_USED_NOU * 1024
                             ELSE AG_USED_NOU * 5
                            END),
                        ROUND(AG_USED_NOU / 2, 2))    total_usg_nou,
                     total_used_charge,
                     total_rated_charge,
                     deduct_code1,
                     deduct_code2,
                     deduct_code3,
                     deduct_code4,
                     deduct_code5,
                     disc_code1,
                     disc_code2,
                     disc_code3,
                     IFNULL(msc_switch_id, switch_id) msc_switch_id,
                     cell_id,
                     ''                               sect_cd,
                     usg_type,
#                      b.code_name                      ag_service_type_name,
                     CAST(usg_seq AS UNSIGNED)        usg_seq,
                     CH_SVC_ICCID,
                     ocall_toll_id,
                     processed_date,
                     processed_time,
                     org_net_info,
                     (CASE org_net_info
                          WHEN '4' THEN 'LTE'
                          WHEN '5' THEN 'LTE(3G망)'
                          WHEN 'D' THEN '3G(LTE망)'
                          WHEN 'I' THEN '5G'
                          WHEN 'H' THEN '5G(LTE망)'
                          ELSE ''
                         END) as                      network_type,
                     opmd_flag,
                     dialed_no,
                     called_no
              from ONLINE_EVDO_RATED_CDR_TEMP a
                       RIGHT OUTER JOIN ui_minor_code b
                                        on a.ag_service_type = b.code_id
              WHERE service_mgmt_no = #{service_mgmt_no}
                AND usg_start_date >= '20200400'
                AND usg_start_date &lt;= '20200501'
#                 AND concat(usg_start_date, usg_start_time) >= '202004010000000'
                AND concat(usg_start_date, usg_start_time) >= #{startDate}
                AND concat(usg_start_date, usg_start_time) &lt;= #{endDate}
                AND b.major_id = 'EVDO_AG_SERVICE_TYPE'
                AND IFNULL(a.AG_SERVICE_TYPE, ' ') &lt;> 'MVP') as ab;
    </select>

    <select id="selectSub" parameterType="HashMap" resultType="map">
        <foreach collection="tables" item="table" separator="UNION ALL">
            SELECT IF(usg_type = 550, '서킷데이터', '데이터통화')     cdr_kind,
                   33                                       cdr_kind_order,
                   DATE_FORMAT(usg_start_date, '%Y/%m/%d')  usg_start_date,
                   usg_start_time                           usg_start_time,
                   total_duration                           total_duration,
                   ''                                       rat_term_phon_num,
                   ''                                       rat_term_phon_num_xxx,
                   total_usg_nou,
                   total_used_charge,
                   total_rated_charge,
                   (total_used_charge - total_rated_charge) deduct_discount_charge,
                   deduct_code1,
                   deduct_code2,
                   deduct_code3,
                   deduct_code4,
                   deduct_code5,
                   disc_code1,
                   disc_code2,
                   disc_code3,
                   msc_switch_id                            switch_id,
                   CONCAT(cell_id, ocall_toll_id) AS        cell_id,
                   ''                                       tzone,
                   usg_type,
                   CASE
                       WHEN opmd_flag = 7 THEN '스마트와치(AW) 데이터공유'
                       WHEN LENGTH(CH_SVC_ICCID) = 14 THEN CONCAT(substr(ch_svc_iccid, 0, 4), '-',
                                                                  substr(ch_svc_iccid, 5, 4), '-',
                                                                  substr(ch_svc_iccid, 9, 4), '-', substr(ch_svc_iccid, 13))
                       ELSE IFNULL(CH_SVC_ICCID, '')
                       END                                  bigo_name,
                   ag_service_type_name                     cont_product_name,
                   network_type,
                   processed_date,
                   processed_time,
                   ''                                       service_term_date,
                   ''                                       service_term_time,
                   usg_seq
            FROM
                 (SELECT usg_start_date,
                 usg_start_time,
                 total_duration,
                 IF(USG_TYPE = 620,
                 (CASE a.PROD_ID
                 WHEN 'NA00002738' THEN AG_USED_NOU * 1024
                 WHEN 'NA00002739' THEN AG_USED_NOU * 1024
                 ELSE AG_USED_NOU * 5
                 END),
                 ROUND(AG_USED_NOU / 2, 2))    total_usg_nou,
                 total_used_charge,
                 total_rated_charge,
                 deduct_code1,
                 deduct_code2,
                 deduct_code3,
                 deduct_code4,
                 deduct_code5,
                 disc_code1,
                 disc_code2,
                 disc_code3,
                 IFNULL(msc_switch_id, switch_id) msc_switch_id,
                 cell_id,
                 ''                               sect_cd,
                 usg_type,
#                  b.code_name                      ag_service_type_name,
                 CAST(usg_seq AS UNSIGNED)        usg_seq,
                 CH_SVC_ICCID,
                 ocall_toll_id,
                 processed_date,
                 processed_time,
                 org_net_info,
                 (CASE org_net_info
                 WHEN '4' THEN 'LTE'
                 WHEN '5' THEN 'LTE(3G망)'
                 WHEN 'D' THEN '3G(LTE망)'
                 WHEN 'I' THEN '5G'
                 WHEN 'H' THEN '5G(LTE망)'
                 ELSE ''
                 END) as                      network_type,
                 opmd_flag,
                 dialed_no,
                 called_no
                 from ${table} a
#                  RIGHT OUTER JOIN ui_minor_code b
#                  on a.ag_service_type = b.code_id
                 WHERE service_mgmt_no = #{service_mgmt_no}
                 AND usg_start_date >= #{startDate}
                 AND usg_start_date &lt;= #{endDate}
                 AND concat(usg_start_date, usg_start_time) >= #{startTime}
                 AND concat(usg_start_date, usg_start_time) &lt;= #{endTime}
#                  AND b.major_id = 'EVDO_AG_SERVICE_TYPE'
                 AND IFNULL(a.AG_SERVICE_TYPE, ' ') &lt;> 'MVP') as a
             </foreach>
    </select>
</mapper>